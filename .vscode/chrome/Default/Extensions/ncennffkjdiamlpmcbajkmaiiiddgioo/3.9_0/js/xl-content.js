var bLoaded;var bPluginEnabled;var bMoniterDynamicLinks;var bWebsiteEnabled;var bPageEnabled;var bMonitorEmule=false;var bMonitorMagnet=false;var bMonitorTradition=false;var bMonitorIE=false;var strMonitorDemain;var strFilterDemain;var strMonitorFileExt;var whiteRegexpArray=[".+sina.com.*\\/d_load.php\\?.+",".+pcpop.com.*\\/redose.aspx\\?.+",".+pcpop.com.*\\/download.php\\?.+",".+pconline.com.cn\\/filedown.jsp\\?.+",".+chinaz.com\\/download.asp\\?.+",".+cnzz.cn\\/download.aspx\\?.+",".+zol.com.*\\/down.php\\?.+",".+zol.com.*\\?.*url=([^\\&]+).*",".+crsky.com.*\\?down_url=([^\\&]+).*",".+skycn.com.*\\/down.php\\?uri=(.+)",".+downxia.com.*\\/download.asp\\?.*url=(.+)"];var blackRegexpArray=["http.+\\?.*url=.+","http.+\\?.*uri=.+"];var s_strHttpSchemeHeaders="HTTP://HTTPS://";var s_strEmuleSchemeHeader="ED2K://";var s_strMagentSchemeHeader="MAGNET:?";var s_strOtherSchemeHeaders="FTP://THUNDER://MMS://MMST://RTSP://RTSPU://XLAPP://";function checkWhiteDynamicLink(e){for(var n in whiteRegexpArray){var r=new RegExp(whiteRegexpArray[n],"i");var t=r.exec(e);if(t==e){return t}if(t!=null&&t.length==2){return t[1]}}return null}function checkBlackDynamicLink(e){for(var n in blackRegexpArray){var r=new RegExp(blackRegexpArray[n],"i");var t=r.exec(e);if(t!=null){return t}}return null}function IsDynamicLink(e){var n=e.toLowerCase();var r=true;if(n.indexOf("?")==-1||n.indexOf("magnet:?")!=-1){r=false}return r}function IsValidUrlAndMonitorProtocol(e){if(e.length==0){return false}var n=e;var r=n.indexOf(":");if(r==-1){return false}var t=n.substr(0,r+1);var i=t.toUpperCase();if(i==""){return false}var a=true;if(s_strEmuleSchemeHeader.indexOf(i)!=-1){if(bMonitorEmule==false){a=false}}else if(s_strMagentSchemeHeader.indexOf(i)!=-1){if(bMonitorMagnet==false){a=false}}else if(s_strHttpSchemeHeaders.indexOf(i)!=-1){if(bMonitorTradition==false){a=false}}else if(s_strOtherSchemeHeaders.indexOf(i)!=-1){if(bMonitorTradition==false){a=false}}else{a=false}return a}function IsValidUrlAndNotHttpProtocol(e){if(e.length==0){return false}var n=e;var r=n.indexOf(":");if(r==-1){return false}var t=n.substr(0,r+1);var i=t.toUpperCase();if(i==""){return false}var a=true;if(s_strEmuleSchemeHeader.indexOf(i)!=-1){if(bMonitorEmule==false){a=false}}else if(s_strMagentSchemeHeader.indexOf(i)!=-1){if(bMonitorMagnet==false){a=false}}else if(s_strOtherSchemeHeaders.indexOf(i)!=-1){if(bMonitorTradition==false){a=false}}else{a=false}return a}function IsMonitorDemain(e){if(e.length==0){return true}var n=new Array;var r=strMonitorDemain.split("||");for(var t in r){var i=r[t].slice(2);var a=i.trimRight("|");n.push(a)}var o=true;var s=e;for(var l in n){if(n[l].length>0&&s.indexOf(n[l])!=-1){o=false;break}}return o}function IsFilterDemain(e){if(e.length==0){return false}if(strFilterDemain.length==0){return false}var n=new Array;var r=strFilterDemain.split("||");for(var t in r){var i=r[t].slice(2).toLowerCase();var a=i.trimRight("|");n.push(a)}var o=false;var s=e.toLowerCase();for(var l in n){if(n[l]>0&&s.indexOf(n[l])!=-1){o=true;break}}return o}function GetExtensionFileName(e){var n=/(\\+)/g;var r=e.replace(n,"#");var t=r.split("#");var i=t[t.length-1];var a=i.split(".");return a[a.length-1]}function IsMonitorFileExt(e){if(e.length==0){return false}var n=e.indexOf(":");if(n==-1){return false}var r=e.toLowerCase();var t=r.substr(0,n+3);var i=t.trimLeft(" ");if(i=="xlapp://"){return true}if(r.indexOf("ed2k://")!=-1||r.indexOf("magnet:?")!=-1){return true}var a=false;var o=GetExtensionFileName(r);if(o.length>0){o+=";";if(strMonitorFileExt.indexOf(o)!=-1){a=true}}return a}function IsURLInMonitor(e,n){if(e.length==0){return false}if(bMonitorIE==false){return false}if(IsValidUrlAndNotHttpProtocol(e)==false){return false}if(IsMonitorDemain(n)==false){return false}if(IsFilterDemain(n)){return false}if(IsMonitorFileExt(e)==false){return false}return true}function IsDownloadURL(e,n,r){var t=IsDynamicLink(e);if(!t){return IsURLInMonitor(e,r)}return false}function checkDownloadLink(e){return IsDownloadURL(e,document.cookie,document.location.href)}function GetConfig(){chrome.extension.sendRequest({name:"GetConfig"},function(e){bMonitorEmule=e.bMonitorEmule;bMonitorMagnet=e.bMonitorMagnet;bMonitorTradition=e.bMonitorTradition;bMonitorIE=e.bMonitorIE;strMonitorDemain=e.monitorDemains;strFilterDemain=e.filterDemains;strMonitorFileExt=e.monitorFileExts})}function CheckEnabled(e,n){chrome.extension.sendRequest({name:"CheckEnabled",url:e,tabId:n},function(e){bPluginEnabled=e.bPlugin;bWebsiteEnabled=e.bWebsite;bPageEnabled=e.bPage})}function CheckActivated(e){chrome.extension.sendRequest({name:"CheckActivated",url:e})}function CheckbMoniterDynamicLinks(e){chrome.extension.sendRequest({name:"CheckbMoniterDynamicLinks"},function(e){bMoniterDynamicLinks=e.bMoniterDynamicLinks})}function onLinkClick(e){if(e.ctrlKey){return}if(bMoniterDynamicLinks){return}if(bPluginEnabled&&bWebsiteEnabled&&bPageEnabled){var n=this.href;checkResult=checkBlackDynamicLink(n);if(checkResult!=null){return}checkResult=checkDownloadLink(n);if(checkResult){chrome.extension.sendRequest({name:"xl_download",link:n,cookie:document.cookie,referurl:document.location.href});e.stopPropagation();e.preventDefault();return}}}function RegisterClickEventListener(){for(var e=0;e<document.links.length;e++){var n=document.links[e];n.addEventListener("click",onLinkClick,false)}}function RegisterDocumentEventListener(){document.addEventListener("keydown",function(e){e.ctrlKey&&chrome.extension.sendRequest({name:"EnabledCapture",capture:false},function(){})}),document.addEventListener("keyup",function(e){e.ctrlKey&&chrome.extension.sendRequest({name:"EnabledCapture",capture:true},function(){})})}function RegisterExtensionMsgListener(){chrome.extension.onMessage.addListener(function(e,n,r){if(e.name=="UpdatePluginEnabled"){bPluginEnabled=e.enable}else if(e.name=="UpdateMoniterDynamicLinks"){bMoniterDynamicLinks=e.enable}else if(e.name=="UpdateWebsiteEnabled"){bWebsiteEnabled=e.enable}else if(e.name=="UpdatePageEnabled"){bPageEnabled=e.enable}else if(e.name=="OnActivated"){if(bLoaded){CheckEnabled(document.location.href,e.tabId);CheckbMoniterDynamicLinks()}}else if(e.name=="GetCookie"){r({cookie:document.cookie})}})}function Init(){bLoaded=true;RegisterExtensionMsgListener();CheckActivated(document.location.href);CheckbMoniterDynamicLinks();RegisterClickEventListener();RegisterDocumentEventListener();GetConfig()}Init();